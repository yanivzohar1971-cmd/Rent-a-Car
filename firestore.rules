rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // MULTI-TENANT FIREBASE RULES FOR RENT_A_CAR APP
    // ============================================================
    // All app data is now stored under user-scoped paths:
    //   users/{uid}/branches
    //   users/{uid}/suppliers
    //   users/{uid}/customers
    //   users/{uid}/reservations
    //   users/{uid}/carSales
    //   users/{uid}/agents
    //   users/{uid}/carTypes
    //   users/{uid}/payments
    //   users/{uid}/commissionRules
    //   users/{uid}/cardStubs
    //   users/{uid}/requests
    //   (and other app data collections)
    //
    // Each authenticated user can ONLY read/write their own data
    // under users/{their_uid}/... paths.
    // ============================================================
    
    // ---- Common functions ----
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Email must be verified (available for future use if stricter rules are needed)
    function isVerified() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    
    // ---- Debug collection for Rent_a_Car ----
    // Used only in DEV/DEBUG, but access is still restricted to authenticated users.
    // Does NOT require email verification.
    match /debug_rentacar/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    // ---- Multi-tenant app data: users/{userId}/... ----
    // All app business data is stored under users/{userId}/{collection}/{docId}
    // 
    // This rule covers ALL subcollections under users/{userId}/:
    //   - users/{userId}/branches/{docId}
    //   - users/{userId}/suppliers/{docId}
    //   - users/{userId}/customers/{docId}
    //   - users/{userId}/reservations/{docId}
    //   - users/{userId}/carSales/{docId}
    //   - users/{userId}/agents/{docId}
    //   - users/{userId}/carTypes/{docId}
    //   - users/{userId}/payments/{docId}
    //   - users/{userId}/commissionRules/{docId}
    //   - users/{userId}/cardStubs/{docId}
    //   - users/{userId}/requests/{docId}
    //   - (and any other future collections under users/{userId}/)
    //
    // Security: Each user can ONLY access their own data.
    //   - request.auth.uid must match the userId in the path
    //   - This ensures complete data isolation between users
    match /users/{userId}/{document=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ---- Public car listings for Buyer portal ----
    // Collection: publicCars/{carId}
    // 
    // These are public listings created by YARD users when they publish a car.
    // Security:
    //   - Anyone (including non-authenticated) can READ (for buyer web portal)
    //   - Only authenticated users can WRITE (create/update/delete)
    //   - On create: ownerUid in request.resource.data must match auth.uid
    //   - On update/delete: ownerUid in existing resource.data must match auth.uid
    match /publicCars/{carId} {
      // Public listings are world-readable for buyers (no auth required)
      allow read: if true;
      
      // Create: client must send ownerUid equal to auth.uid
      allow create: if isAuthenticated()
                    && request.resource.data.ownerUid == request.auth.uid;
      
      // Update/Delete: ownership is checked against the existing document
      allow update, delete: if isAuthenticated()
                            && resource.data.ownerUid == request.auth.uid;
    }
    
    // ---- Default deny for everything else ----
    // This ensures that:
    //   1. Old top-level collections (customers, suppliers, etc.) are denied
    //   2. Any other paths not explicitly allowed above are denied
    //   3. Unauthenticated users cannot access any app data
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ============================================================
// DEPLOYMENT INSTRUCTIONS
// ============================================================
// To deploy these rules to Firebase:
//
// 1. Copy the entire content of this file (from "rules_version" to the closing brace)
//
// 2. Go to Firebase Console: https://console.firebase.google.com/
//
// 3. Select your project (carexpert-94faa)
//
// 4. Navigate to: Firestore Database â†’ Rules tab
//
// 5. Paste the rules content into the editor
//
// 6. Click "Publish" button
//
// 7. Wait for deployment confirmation
//
// After deployment, the app should be able to:
//   - Read/write to users/{uid}/branches, users/{uid}/suppliers, etc.
//   - No more PERMISSION_DENIED errors for user-scoped collections
//   - Complete data isolation between different users
//
// NOTE: These rules replace the old top-level collection rules.
//       Old collections (branches, suppliers, etc.) at the root level
//       will be denied access, which is expected since the app now
//       uses user-scoped paths exclusively.
// ============================================================
