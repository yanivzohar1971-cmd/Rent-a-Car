rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ---- Common functions ----
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Email must be verified (for business data access)
    function isVerified() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    
    // ---- Rent_a_Car App Collections ----
    // The following collections are used by the Rent_a_Car Android app (com.rentacar.app):
    // - debug_rentacar: Debug logging collection
    // - customers: Customer data
    // - suppliers: Supplier data
    // - agents: Agent data
    // - carTypes: Car type catalog
    // - branches: Branch locations
    // - reservations: Reservation/order data
    // - payments: Payment records
    // - commissionRules: Commission calculation rules
    // - cardStubs: Credit card stub information
    // - requests: Customer requests
    // - carSales: Car sale records
    
    // ---- Debug collection for Rent_a_Car ----
    // Used only in DEV/DEBUG, but access is still restricted to authenticated users.
    // Does NOT require email verification.
    match /debug_rentacar/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    // ---- User profiles for Rent_a_Car ----
    // Per-user profiles stored under /users/{uid}
    // Each authenticated user can only read/write their own profile.
    // This is allowed even if the email is not yet verified.
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ---- Core Rent_a_Car app collections ----
    // These collections require authenticated AND email-verified users.
    
    match /customers/{docId} {
      allow read, write: if isVerified();
    }
    
    match /suppliers/{docId} {
      allow read, write: if isVerified();
    }
    
    match /agents/{docId} {
      allow read, write: if isVerified();
    }
    
    match /carTypes/{docId} {
      allow read, write: if isVerified();
    }
    
    match /branches/{docId} {
      allow read, write: if isVerified();
    }
    
    match /reservations/{docId} {
      allow read, write: if isVerified();
    }
    
    match /payments/{docId} {
      allow read, write: if isVerified();
    }
    
    match /commissionRules/{docId} {
      allow read, write: if isVerified();
    }
    
    match /cardStubs/{docId} {
      allow read, write: if isVerified();
    }
    
    match /requests/{docId} {
      allow read, write: if isVerified();
    }
    
    match /carSales/{docId} {
      allow read, write: if isVerified();
    }
    
    // ---- Default deny for everything else ----
    // This ensures that any collection not explicitly listed above is denied access.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
