rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // DEVELOPMENT vs PRODUCTION NOTES
    // ============================================================
    // Current rules allow authenticated users to READ and WRITE all business
    // collections (needed for DataSyncCheck and sync workers to work).
    // 
    // Both READ and WRITE access use isAuthenticated() (any logged-in user).
    // This allows the app to work even if email verification is pending.
    //
    // TODO: For production, consider tightening to isVerified() if you want
    // to restrict access to verified users only. However, this would require
    // email verification before DataSyncCheck and sync can work.
    // ============================================================
    
    // ---- Common functions ----
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Email must be verified (available for future use if stricter rules are needed)
    function isVerified() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    
    // ---- Rent_a_Car App Collections ----
    // The following collections are used by the Rent_a_Car Android app (com.rentacar.app):
    // - debug_rentacar: Debug logging collection
    // - customers: Customer data
    // - suppliers: Supplier data
    // - agents: Agent data
    // - carTypes: Car type catalog
    // - branches: Branch locations
    // - reservations: Reservation/order data
    // - payments: Payment records
    // - commissionRules: Commission calculation rules
    // - cardStubs: Credit card stub information
    // - requests: Customer requests
    // - carSales: Car sale records
    
    // ---- Debug collection for Rent_a_Car ----
    // Used only in DEV/DEBUG, but access is still restricted to authenticated users.
    // Does NOT require email verification.
    match /debug_rentacar/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    // ---- User profiles for Rent_a_Car ----
    // Per-user profiles stored under /users/{uid}
    // Each authenticated user can only read/write their own profile.
    // This is allowed even if the email is not yet verified.
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ---- Core Rent_a_Car app collections ----
    // These collections are used by DataSyncCheck and the main app.
    //
    // READ ACCESS: Any authenticated user can read (needed for DataSyncCheck counts).
    //   This allows the app to work even if email verification is pending.
    //
    // WRITE ACCESS: Any authenticated user can write (needed for sync workers).
    //   This allows CloudDeltaSyncWorker to sync local data to Firestore.
    //   TODO: For production, consider tightening to isVerified() if you want
    //   to restrict writes to verified users only.
    
    match /customers/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /suppliers/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /agents/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /carTypes/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /branches/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /reservations/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /payments/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /commissionRules/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /cardStubs/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /requests/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /carSales/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ---- Default deny for everything else ----
    // This ensures that any collection not explicitly listed above is denied access.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
